<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Fret Trainer — Mobile-friendly</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#fafafa; --card:#fff; --text:#222; --muted:#6b7280;
      --accent:#0a84ff; --ok:#34c759; --shadow:0 4px 16px rgba(0,0,0,.08);
      --barA:#6fa8ff; --barB:#2e7cff;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);
      font-family:"SF Pro Display",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      display:flex;flex-direction:column;align-items:center;padding:28px}
    header{font-size:24px;font-weight:600;margin-bottom:20px}

    /* ===== Hamburger & Side Menu ===== */
    .menu-btn{position:fixed;top:12px;left:12px;width:36px;height:36px;border-radius:10px;
      display:flex;align-items:center;justify-content:center;cursor:pointer;background:#fff;box-shadow:var(--shadow);z-index:10000}
    .menu-icon{width:18px;height:12px;position:relative}
    .menu-icon span{position:absolute;left:0;right:0;height:2px;background:#333;border-radius:2px}
    .menu-icon span:nth-child(1){top:0}
    .menu-icon span:nth-child(2){top:5px}
    .menu-icon span:nth-child(3){top:10px}

    .side-menu{position:fixed;top:0;right:-320px;height:100%;width:320px;background:#fff;box-shadow:-2px 0 16px rgba(0,0,0,.15);
      padding:20px;transition:right .28s ease;z-index:9999;display:flex;flex-direction:column;gap:14px}
    .side-menu.open{right:0}
    .side-title{font-size:16px;font-weight:700;margin:6px 0 2px}
    .side-sub{font-size:12px;color:#666;margin:0 0 10px}
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-size:13px;color:#333}
    .range-row{display:flex;align-items:center;gap:10px}
    .range-row input[type="range"]{flex:1}
    .row{display:flex;align-items:center;gap:10px}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid #e5e7eb;background:#f7f7f9;cursor:pointer}
    .btn.primary{background:#0a84ff;color:#fff;border-color:#0a84ff}
    .btn.danger{background:#ff3b30;color:#fff;border-color:#ff3b30}

    /* Meter */
    .meter{margin-top:2px}
    .meter-bg{position:relative;height:12px;border-radius:8px;overflow:hidden;background:linear-gradient(90deg,#2ecc71,#f1c40f,#e74c3c)}
    .meter-bar{position:absolute;left:0;top:0;bottom:0;width:0%;background:rgba(255,255,255,.6)}
    .meter-values{display:flex;justify-content:space-between;font-size:11px;color:#666;margin-top:4px}

    .card{background:var(--card);border-radius:20px;box-shadow:var(--shadow);padding:24px;margin-bottom:16px;width:min(900px,92vw)}
    .quiz-label{font-size:13px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin-bottom:8px;text-align:center}
    .quiz-note{font-size:88px;font-weight:800;line-height:1;margin:0;text-align:center}
    .quiz-string{font-size:36px;color:#444;text-align:center;margin-top:8px}
    .status{min-height:24px;text-align:center;margin-top:10px;font-size:15px;color:#2e8b57}

    .controls{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:18px}
    button{font-size:15px;padding:10px 18px;border-radius:12px;border:none;cursor:pointer;background:#f0f0f5;transition:background .2s,opacity .2s}
    button:hover{background:#e0e0eb}
    .success{background:var(--ok);color:#fff}
    .success:hover{background:#2caa4c}
    .ghost{background:#f6f6f8}

    .picker{margin-top:14px}
    .picker h3{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin:0 0 8px}
    .row-inline{display:flex;flex-wrap:wrap;gap:14px;align-items:center}
    .row-inline label{cursor:pointer}
    .row-inline select{padding:8px 10px;border-radius:10px;border:1px solid #ddd;background:#fff;font-size:14px}
    .string-pills{display:flex;flex-wrap:wrap;gap:10px}

    /* Fretboard */
    .fretboard-wrap{margin-top:18px}
    .fretboard-title{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin:0 0 8px}
    .fretboard{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:var(--shadow);padding:16px}
    .fb-svg{width:100%;height:auto;display:block}

    /* Progress bottom */
    .progress{margin-top:22px}
    .progress h2{font-size:13px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin:0 0 10px}
    .bar-row{display:flex;align-items:center;gap:10px;margin:8px 0}
    .bar-label{width:32px;font-weight:600}
    .bar-wrap{flex:1;height:10px;background:#eee;border-radius:6px;overflow:hidden}
    .bar{height:100%;background:linear-gradient(90deg,var(--barA),var(--barB));width:0%}
    .bar-info{width:180px;text-align:right;color:#555;font-size:12px}
  </style>
</head>
<body>
  <!-- Hamburger button -->
  <div id="menuBtn" class="menu-btn" aria-label="Open settings" role="button">
    <div class="menu-icon" aria-hidden="true"><span></span><span></span><span></span></div>
  </div>

  <!-- Side menu (Mic settings) -->
  <aside id="sideMenu" class="side-menu" aria-hidden="true">
    <div class="side-title">Microphone Settings</div>
    <p class="side-sub">Adjust gain and enable smartphone EQ boost.</p>

    <div class="field">
      <label>Mic</label>
      <div class="row">
        <button id="toggleMicBtn" class="btn primary" aria-pressed="false">Mic ON</button>
        <span id="micStateTxt" style="font-size:12px;color:#666">Off</span>
      </div>
    </div>

    <div class="field">
      <label for="gainSlider">Gain Match</label>
      <div class="range-row">
        <input type="range" id="gainSlider" min="0.5" max="10" step="0.1" value="2.0" />
        <span id="gainValue" style="width:50px;text-align:right">2.0×</span>
      </div>
      <div class="meter">
        <div class="meter-bg"><div class="meter-bar" id="meterOut"></div></div>
        <div class="meter-values"><span>-60 dB</span><span>-30 dB</span><span>-10 dB</span><span id="dbOut">-∞ dB</span></div>
      </div>
    </div>

    <div class="field">
      <label class="row" style="justify-content:space-between">
        <span>Smartphone Mode (EQ Boost)</span>
        <input type="checkbox" id="mobileEq" />
      </label>
      <small class="side-sub">Boosts ~250 Hz (+4 dB) for phone microphones.</small>
    </div>
  </aside>

  <header>Fret Trainer</header>

  <!-- Quiz card -->
  <section class="card" id="quizCard">
    <div class="quiz-label">Current Question</div>
    <h1 class="quiz-note" id="targetNote">C</h1>
    <div class="quiz-string" id="targetString">String 3</div>
    <div class="status" id="statusText">Mic Off</div>

    <div class="controls">
      <button class="success" id="restartBtn" aria-pressed="false">Restart</button>
      <button class="ghost" id="exportBtn">Export CSV</button>
      <button class="ghost" id="importBtn">Import CSV</button>
      <input type="file" id="importInput" accept=".csv" style="display:none" />
    </div>

    <div class="picker">
      <h3>Instrument</h3>
      <div class="row-inline" id="instrumentRow">
        <label><input type="radio" name="category" value="guitar" checked> Guitar</label>
        <label><input type="radio" name="category" value="bass"> Bass</label>
        <select id="variantSelect" title="Variant"></select>
      </div>
    </div>

    <div class="picker">
      <h3>Strings to include</h3>
      <div class="string-pills" id="stringPicker"></div>
    </div>

    <!-- Fretboard appears after correct and stays until next correct -->
    <div class="fretboard-wrap" id="fbWrap" style="display:none">
      <div class="fretboard-title">Fretboard (0–12)</div>
      <div class="fretboard"><svg id="fbSvg" class="fb-svg" viewBox="0 0 860 220" preserveAspectRatio="xMidYMid meet"></svg></div>
    </div>

    <!-- Progress at bottom -->
    <div class="progress">
      <h2 id="progressTitle">Score</h2>
      <div id="bars"></div>
    </div>
  </section>

  <script>
  /* =============================
     Config / Theory
  ============================= */
  const NOTE_NAMES = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];

  const TUNINGS = {
    guitar6: ["E4","B3","G3","D3","A2","E2"],
    bass4:   ["G2","D2","A1","E1"],
    bass5:   ["G2","D2","A1","E1","B0"],
    bass6:   ["C3","G2","D2","A1","E1","B0"],
  };
  const VARIANTS = {
    guitar: [{id:"guitar6", label:"Guitar 6"}],
    bass:   [{id:"bass4", label:"Bass 4"},{id:"bass5", label:"Bass 5"},{id:"bass6", label:"Bass 6"}],
  };

  /* ==== UX constants ==== */
  const HOLD_TIME_MS = 700;      // sustain time to confirm a correct note
  const START_IGNORE_MS = 500;   // ignore detections right after a new question
  const NEXT_QUESTION_DELAY_MS = 650; // delay before showing next question
  const FFT_SIZE = 4096;
  const LAST_N = 20;
  const WRONG_LOG_COOLDOWN = 800;

  // Fixed absolute baseline (your request)
  const BASELINE_RT_C = 2000; // ms (Score = min(1, 2000 / avgRT))

  /* =============================
     State
  ============================= */
  let category = 'guitar';
  let variant  = 'guitar6';
  let fretMap  = buildFretMap(variant);

  let selectedStrings = [];
  let current = { note:'C', string:3, fret:0 };

  let listening=false, ctx=null, analyser=null, srcNode=null, hp=null, lp=null, gainNode=null, eqBoost=null, rafId=null;
  let holdStart=null, questionStartAt=0, questionIssuedAt=0, lastWrongAt=0;
  let meterRAF=null;

  const results = []; // {timestamp, category, note, string, fret, result, rt_ms}

  /* =============================
     DOM refs
  ============================= */
  const targetNoteEl = document.getElementById('targetNote');
  const targetStringEl = document.getElementById('targetString');
  const statusEl = document.getElementById('statusText');
  const barsEl = document.getElementById('bars');
  const progressTitleEl = document.getElementById('progressTitle');
  const fbWrap = document.getElementById('fbWrap');
  const fbSvg = document.getElementById('fbSvg');

  // Menu
  const menuBtn = document.getElementById('menuBtn');
  const sideMenu = document.getElementById('sideMenu');
  const toggleMicBtn = document.getElementById('toggleMicBtn');
  const micStateTxt = document.getElementById('micStateTxt');
  const gainSlider = document.getElementById('gainSlider');
  const gainValue  = document.getElementById('gainValue');
  const mobileEqCb = document.getElementById('mobileEq');
  const meterOut = document.getElementById('meterOut');
  const dbOutEl  = document.getElementById('dbOut');

  /* =============================
     Menu wiring
  ============================= */
  menuBtn.addEventListener('click', ()=>{
    const open = sideMenu.classList.toggle('open');
    sideMenu.setAttribute('aria-hidden', open? 'false':'true');
  });

  toggleMicBtn.addEventListener('click', async ()=>{
    if(listening){ await stopMic(); }
    else { await startMic(parseFloat(gainSlider.value||'2.0')); }
  });
  gainSlider.addEventListener('input', ()=>{
    const v = parseFloat(gainSlider.value||'1');
    gainValue.textContent = v.toFixed(1)+'×';
    if(gainNode) gainNode.gain.value = v;
  });
  mobileEqCb.addEventListener('change', ()=>{
    if(!ctx || !gainNode || !hp) return;
    applyEqChain(mobileEqCb.checked);
  });

  /* =============================
     Helpers
  ============================= */
  function noteNameToMidi(s){
    const m = s.match(/^([A-G])(#?)(-?\d+)$/);
    const name = m[1]+(m[2]||""); const oct=parseInt(m[3],10);
    return (oct+1)*12 + NOTE_NAMES.indexOf(name);
  }
  function freqToNoteName(freq){
    if(!freq || !isFinite(freq) || freq<=0) return null;
    const midi = Math.round(69 + 12*Math.log2(freq/440));
    return NOTE_NAMES[(midi%12+12)%12];
  }
  function buildFretMap(variant){
    const tuning=TUNINGS[variant]; const map=[]; const MAX_FRET=12;
    for(let s=0;s<tuning.length;s++){
      const open=noteNameToMidi(tuning[s]); const arr=[];
      for(let f=0;f<=MAX_FRET;f++){ const midi=open+f; arr.push({fret:f,name:NOTE_NAMES[(midi%12+12)%12]}); }
      map.push(arr);
    } return map;
  }

  function rebuildVariantSelect(){
    const sel = document.getElementById('variantSelect'); sel.innerHTML='';
    VARIANTS[category].forEach(v=>{ const o=document.createElement('option'); o.value=v.id; o.textContent=v.label; sel.appendChild(o); });
    variant = VARIANTS[category][0].id; sel.value=variant;
    sel.onchange=()=>{ variant=sel.value; fretMap=buildFretMap(variant); rebuildStringPicker(); chooseQuestion(); renderProgress(); };
  }
  function rebuildStringPicker(){
    const wrap=document.getElementById('stringPicker'); wrap.innerHTML=''; selectedStrings=[];
    const n=fretMap.length; for(let i=1;i<=n;i++){ const lab=document.createElement('label'); const cb=document.createElement('input'); cb.type='checkbox'; cb.value=String(i); cb.checked=true; cb.onchange=()=>{ if(getSelectedStrings().length===0) cb.checked=true; }; lab.appendChild(cb); lab.appendChild(document.createTextNode(' String '+i)); wrap.appendChild(lab); selectedStrings.push(i); }
  }
  function getSelectedStrings(){ return Array.from(document.querySelectorAll('#stringPicker input:checked')).map(el=>parseInt(el.value,10)); }

  /* =============================
     Quiz flow
  ============================= */
  function chooseQuestion(){
    const usable=getSelectedStrings(); const pool=usable.length?usable:Array.from({length:fretMap.length},(_,i)=>i+1);
    const s1=pool[Math.floor(Math.random()*pool.length)]; const s0=s1-1;
    const note=NOTE_NAMES[Math.floor(Math.random()*12)];
    const posList=fretMap[s0].filter(x=>x.name===note); const pos=posList[Math.floor(Math.random()*posList.length)]||{fret:0,name:note};
    current.note=note; current.string=s1; current.fret=pos.fret;

    targetNoteEl.textContent=current.note; targetStringEl.textContent=`String ${current.string}`;
    statusEl.textContent = listening? 'Listening…' : 'Mic Off';

    holdStart=null; questionStartAt=performance.now(); questionIssuedAt=performance.now();
  }

  function markCorrect(){
    const rt=Math.round(performance.now()-questionStartAt);
    statusEl.textContent='Correct!';
    results.push({timestamp:new Date().toISOString(), category, note:current.note, string:current.string, fret:current.fret, result:'correct', rt_ms:rt});
    playSuccessSound(); renderProgress(); drawFretboard();
    setTimeout(()=>{ chooseQuestion(); }, NEXT_QUESTION_DELAY_MS);
  }

  function logWrong(){
    const now=performance.now(); if(now-lastWrongAt<WRONG_LOG_COOLDOWN) return; lastWrongAt=now;
    results.push({timestamp:new Date().toISOString(), category, note:current.note, string:current.string, fret:current.fret, result:'wrong', rt_ms:''});
    renderProgress();
  }

  /* =============================
     Fretboard (SVG)
  ============================= */
  function drawFretboard(){
    const tuning = TUNINGS[variant];
    const strings = tuning.map(n=> n.replace(/\d+$/,'') );
    const S = strings.length; const F = 12; // 0..12
    const W = 860, H = 220; const leftPad = 50; const rightPad = 10; const topPad=20; const bottomPad=30;
    const innerW = W-leftPad-rightPad; const innerH = H-topPad-bottomPad;
    const fretW = innerW/(F+1); // 0..12 => 13 spaces
    const stringGap = innerH/(S-1);

    fbSvg.setAttribute('viewBox',`0 0 ${W} ${H}`);
    fbSvg.replaceChildren();

    // background
    const bg = document.createElementNS('http://www.w3.org/2000/svg','rect');
    bg.setAttribute('x',0); bg.setAttribute('y',0); bg.setAttribute('width',W); bg.setAttribute('height',H); bg.setAttribute('fill','#ffffff');
    fbSvg.appendChild(bg);

    // strings + labels
    for(let i=0;i<S;i++){
      const y = topPad + i*stringGap;
      const line = document.createElementNS('http://www.w3.org/2000/svg','line');
      line.setAttribute('x1', leftPad); line.setAttribute('x2', leftPad+innerW);
      line.setAttribute('y1', y); line.setAttribute('y2', y);
      line.setAttribute('stroke', '#333'); line.setAttribute('stroke-width', i===0?1.2: i===S-1?1.6:1);
      fbSvg.appendChild(line);
      const t = document.createElementNS('http://www.w3.org/2000/svg','text');
      t.setAttribute('x', leftPad-18); t.setAttribute('y', y+4); t.setAttribute('text-anchor','end'); t.setAttribute('font-size','12'); t.setAttribute('fill','#444');
      t.textContent = strings[i]; fbSvg.appendChild(t);
    }

    // frets: 0は描かない / 1は太線（ナット）
    for(let f=0; f<=F; f++){
      const x = leftPad + f*fretW;
      const line = document.createElementNS('http://www.w3.org/2000/svg','line');
      line.setAttribute('x1', x); line.setAttribute('x2', x);
      line.setAttribute('y1', topPad-4); line.setAttribute('y2', topPad+innerH+4);
      line.setAttribute('stroke', f===1?'#111':'#bbb'); line.setAttribute('stroke-width', f===1?5:1);
      if (f!==0) fbSvg.appendChild(line); // 左端は線なし
      const t = document.createElementNS('http://www.w3.org/2000/svg','text');
      t.setAttribute('x', x + fretW/2); t.setAttribute('y', H-10); t.setAttribute('text-anchor','middle'); t.setAttribute('font-size','11'); t.setAttribute('fill','#666');
      t.textContent = String(f); fbSvg.appendChild(t);
    }

    // dots: 3,5,7,9 single center; 12 is symmetric double (vertical)
    [3,5,7,9,12].forEach(fm => {
      const cxm = leftPad + fm*fretW + fretW*0.5;
      if (fm === 12) {
        const yTop = topPad + innerH * 0.35;
        const yBottom = topPad + innerH * 0.65;
        [yTop, yBottom].forEach(cy=>{
          const d = document.createElementNS('http://www.w3.org/2000/svg','circle');
          d.setAttribute('cx', cxm); d.setAttribute('cy', cy); d.setAttribute('r', 5);
          d.setAttribute('fill','none'); d.setAttribute('stroke','#bbb'); d.setAttribute('stroke-width','1.5');
          fbSvg.appendChild(d);
        });
      } else {
        const d = document.createElementNS('http://www.w3.org/2000/svg','circle');
        d.setAttribute('cx', cxm); d.setAttribute('cy', topPad + innerH*0.50); d.setAttribute('r', 5);
        d.setAttribute('fill','none'); d.setAttribute('stroke','#bbb'); d.setAttribute('stroke-width','1.5');
        fbSvg.appendChild(d);
      }
    });

    // correct position marker
    const sIdx = current.string-1; const y = topPad + sIdx*stringGap;
    const cx = leftPad + (current.fret===0 ? fretW*0.25 : current.fret*fretW + fretW*0.5);
    const circle = document.createElementNS('http://www.w3.org/2000/svg','circle');
    circle.setAttribute('cx', cx); circle.setAttribute('cy', y); circle.setAttribute('r', 10);
    circle.setAttribute('fill', '#ffffff'); circle.setAttribute('stroke', '#0a84ff'); circle.setAttribute('stroke-width', 3);
    fbSvg.appendChild(circle);

    fbWrap.style.display='block';
  }

  /* =============================
     Progress (absolute score vs fixed C=2000ms)
  ============================= */
  function summarizeAvgRtLastN(note){
    const arr = results.filter(r=>r.category===category && r.note===note);
    if(!arr.length) return null;
    const recent = arr.slice(-LAST_N).filter(r=>r.result==='correct');
    if(!recent.length) return null;
    return recent.reduce((s,r)=>s+(Number(r.rt_ms)||0),0)/recent.length;
  }
  function renderProgress(){
    progressTitleEl.textContent = `Score`;
    barsEl.innerHTML='';
    NOTE_NAMES.forEach(n=>{
      const avgRt = summarizeAvgRtLastN(n);
      const score = avgRt? Math.min(1, BASELINE_RT_C / avgRt) : 0;
      const row=document.createElement('div'); row.className='bar-row';
      const lab=document.createElement('div'); lab.className='bar-label'; lab.textContent=n; row.appendChild(lab);
      const wrap=document.createElement('div'); wrap.className='bar-wrap';
      const bar=document.createElement('div'); bar.className='bar'; bar.style.width=(score*100).toFixed(0)+'%';
      wrap.appendChild(bar); row.appendChild(wrap);
      const info=document.createElement('div'); info.className='bar-info';
      info.textContent = avgRt? `avg:${Math.round(avgRt)}ms | score:${(score*100).toFixed(0)}%` : '-';
      row.appendChild(info);
      barsEl.appendChild(row);
    });
  }

  /* =============================
     CSV I/O (per category)
  ============================= */
  function exportCSV(){
    const head='timestamp,category,note,string,fret,result,rt_ms\n';
    const rows=results.filter(r=>r.category===category).map(r=>`${r.timestamp},${r.category},${r.note},${r.string},${r.fret},${r.result},${r.rt_ms}`).join('\n');
    const blob=new Blob([head+rows+(rows?'\n':'')],{type:'text/csv'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`${category}_results.csv`; a.click();
  }
  function importCSVFile(file){
    const reader=new FileReader(); reader.onload=(e)=>{
      const lines=e.target.result.split(/\r?\n/).slice(1); let added=0;
      lines.forEach(line=>{ if(!line.trim()) return; const [timestamp,cat,note,string,fret,result,rt_ms]=line.split(','); results.push({timestamp,category:cat,note,string:Number(string),fret:Number(fret),result,rt_ms:rt_ms||''}); added++; });
      renderProgress(); statusEl.textContent=`Imported ${added} rows`; setTimeout(()=>{ statusEl.textContent=listening?'Listening…':'Mic Off'; }, 900);
    }; reader.readAsText(file);
  }

  /* =============================
     Audio & Pitch & Meter
  ============================= */
  async function startMic(gainValue=2.0){
    try{
      const stream=await navigator.mediaDevices.getUserMedia({ audio:{ echoCancellation:false, noiseSuppression:false, autoGainControl:false } });
      ctx=new (window.AudioContext||window.webkitAudioContext)();
      analyser=ctx.createAnalyser(); analyser.fftSize = FFT_SIZE;
      hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=30;
      lp=ctx.createBiquadFilter(); lp.type='lowpass';  lp.frequency.value=1200;
      gainNode = ctx.createGain(); gainNode.gain.value=gainValue;

      srcNode=ctx.createMediaStreamSource(stream);
      // initial chain without EQ; applyEqChain() may insert eq
      gainNode.disconnect(); hp.disconnect(); lp.disconnect();
      srcNode.connect(gainNode);
      applyEqChain(mobileEqCb.checked); // connect onwards into hp -> lp -> analyser

      listening=true; toggleMicBtn.textContent='Mic OFF'; toggleMicBtn.classList.add('danger'); toggleMicBtn.classList.remove('primary');
      toggleMicBtn.setAttribute('aria-pressed','true'); micStateTxt.textContent='On'; statusEl.textContent='Listening…';
      startMeterLoop();
      loopDetect();
    }catch(err){ alert('Mic error: '+err.message); }
  }

  async function stopMic(){
    listening=false; if(rafId) cancelAnimationFrame(rafId); stopMeterLoop();
    try{
      if(srcNode) srcNode.disconnect(); if(gainNode) gainNode.disconnect(); if(eqBoost) eqBoost.disconnect();
      if(hp) hp.disconnect(); if(lp) lp.disconnect(); if(analyser) analyser.disconnect();
      if(ctx){ await ctx.close(); }
    }catch(_){ }
    ctx=null; analyser=null; srcNode=null; hp=null; lp=null; gainNode=null; eqBoost=null;
    toggleMicBtn.textContent='Mic ON'; toggleMicBtn.classList.add('primary'); toggleMicBtn.classList.remove('danger');
    toggleMicBtn.setAttribute('aria-pressed','false'); micStateTxt.textContent='Off'; statusEl.textContent='Mic Off';
  }

  function applyEqChain(useEq){
    try{
      if(!srcNode || !gainNode || !hp || !lp || !analyser) return;
      try{ gainNode.disconnect(); }catch(_){ }
      if(useEq){
        if(!eqBoost){ eqBoost = ctx.createBiquadFilter(); eqBoost.type='peaking'; eqBoost.frequency.value=250; eqBoost.gain.value=4; eqBoost.Q.value=1.0; }
        gainNode.connect(eqBoost); eqBoost.connect(hp);
      } else {
        if(eqBoost){ try{ eqBoost.disconnect(); }catch(_){ } }
        gainNode.connect(hp);
      }
      hp.connect(lp); lp.connect(analyser);
    }catch(_){ }
  }

  function loopDetect(){
    if(!listening) return;
    const buf=new Float32Array(analyser.fftSize); analyser.getFloatTimeDomainData(buf);
    const f=autoCorrelate(buf,ctx.sampleRate);
    if(f && f>30 && f<1500){ const n=freqToNoteName(f); if(n) handleDetected(n); } else { holdStart=null; }
    rafId=requestAnimationFrame(loopDetect);
  }
  function handleDetected(name){
    if (performance.now() - questionIssuedAt < START_IGNORE_MS) return;
    const now=performance.now();
    if(name===current.note){ if(!holdStart) holdStart=now; if(now-holdStart>=HOLD_TIME_MS){ markCorrect(); holdStart=null; } }
    else { holdStart=null; logWrong(); }
  }

  // ====== Meter (post-gain) ======
  function startMeterLoop(){
    if(meterRAF) cancelAnimationFrame(meterRAF);
    const buf = new Float32Array(analyser.fftSize);
    const toDb = (rms)=> (rms>0? 20*Math.log10(rms) : -Infinity);
    const toPct = db => Math.max(0, Math.min(100, (db + 60) / 60 * 100)); // -60..0 -> 0..100
    const tick = ()=>{
      if(!ctx || !analyser){ meterRAF=null; return; }
      analyser.getFloatTimeDomainData(buf);
      let rms=0; for(let i=0;i<buf.length;i++){ const v=buf[i]; rms+=v*v; } rms=Math.sqrt(rms/buf.length);
      const db = toDb(rms); dbOutEl.textContent = (isFinite(db)? db.toFixed(1) : '-∞')+ ' dB';
      meterOut.style.width = toPct(isFinite(db)? db : -60) + '%';
      meterRAF = requestAnimationFrame(tick);
    };
    meterRAF = requestAnimationFrame(tick);
  }
  function stopMeterLoop(){ if(meterRAF) cancelAnimationFrame(meterRAF); meterRAF=null; }

  function autoCorrelate(buf, sr){
    const N=buf.length; let rms=0; for(let i=0;i<N;i++){ rms+=buf[i]*buf[i]; }
    rms=Math.sqrt(rms/N); if(rms < 0.008) return null; // simple gate
    let r1=0,r2=N-1,t=0.2; for(let i=0;i<N/2;i++){ if(Math.abs(buf[i])<t){ r1=i; break; } }
    for(let i=1;i<N/2;i++){ if(Math.abs(buf[N-i])<t){ r2=N-i; break; } }
    const b=buf.slice(r1,r2); const M=b.length; if(M<64) return null;
    const c=new Float32Array(M); for(let lag=0;lag<M;lag++){ let s=0; for(let i=0;i<M-lag;i++) s+=b[i]*b[i+lag]; c[lag]=s; }
    let d=0; while(d<M-1 && c[d]>c[d+1]) d++; let max=-1,pos=-1; for(let i=d;i<M;i++){ if(c[i]>max){ max=c[i]; pos=i; } }
    if(pos<=0) return null; const y0=c[pos-1]||0,y1=c[pos],y2=c[pos+1]||0; const shift=(y2-y0)/(2*(2*y1-y2-y0)||1); return sr/(pos+shift);
  }

  function playSuccessSound(){
    const ac=new (window.AudioContext||window.webkitAudioContext)();
    [261.63,329.63,392.00].forEach(f=>{ const o=ac.createOscillator(), g=ac.createGain(); o.type='sine'; o.frequency.value=f; g.gain.setValueAtTime(.18,ac.currentTime); g.gain.exponentialRampToValueAtTime(0.001, ac.currentTime+.9); o.connect(g).connect(ac.destination); o.start(); o.stop(ac.currentTime+.92); });
  }

  /* =============================
     Wire-up
  ============================= */
  document.getElementById('restartBtn').addEventListener('click', ()=>{
    chooseQuestion(); const btn=document.getElementById('restartBtn'); btn.setAttribute('aria-pressed','true'); btn.style.opacity='.9'; setTimeout(()=>{ btn.setAttribute('aria-pressed','false'); btn.style.opacity='1'; }, 140);
  });
  document.getElementById('exportBtn').addEventListener('click', exportCSV);
  document.getElementById('importBtn').addEventListener('click', ()=> document.getElementById('importInput').click());
  document.getElementById('importInput').addEventListener('change', (e)=>{ if(e.target.files[0]) importCSVFile(e.target.files[0]); e.target.value=''; });
  Array.from(document.querySelectorAll('input[name="category"]')).forEach(r=> r.addEventListener('change', (e)=>{ category=e.target.value; rebuildVariantSelect(); fretMap=buildFretMap(variant); rebuildStringPicker(); chooseQuestion(); renderProgress(); }));

  // init
  rebuildVariantSelect(); rebuildStringPicker(); chooseQuestion(); renderProgress();
  </script>
</body>
</html>
